#!/bin/sh

mknod -m 666 /dev/null c 1 3

chmod 644 /etc/passwd
chmod 644 /etc/group
chmod 755 /bin/*
chmod 755 /bin/*
chmod 700 -R /root
chmod 777 /home/ctf
chown ctf /home/ctf
chmod 755 /home/ctf/vuln.ko
chmod 755 /home/ctf/wrapper
chown root /home/ctf/flag
chmod 400 /home/ctf/flag

mount -t proc none /proc
mount -t devtmpfs devtmpfs /dev
mount -t tmpfs -o "noexec,nosuid,size=10%,mode=0755" tmpfs /run

# Uncomment below to enable shared folder with host
# to aid in exploit development
#mount -t 9p -o trans=virtio,version=9p2000.L,nosuid hostshare /home/ctf

/sbin/mdev -s

mkdir -p /dev/pts
mount -vt devpts -o gid=4,mode=620 none /dev/pts
chmod 666 /dev/ptmx
exec 0</dev/console
exec 1>/dev/console
exec 2>/dev/console

echo 2 > /proc/sys/kernel/kptr_restrict
echo 1 > /proc/sys/kernel/dmesg_restrict

insmod /home/ctf/vuln.ko
mknod -m 600 /dev/vuln c `grep vuln /proc/devices | awk '{print $1;}'` 0
chmod 0666 /dev/vuln
echo -e "\nBoot took $(cut -d' ' -f1 /proc/uptime) seconds\n"

stty raw -echo

#setsid cttyhack setuidgid 0 sh  # debug
#setsid cttyhack setuidgid ctf /home/ctf/wrapper
setuidgid 1000 /home/ctf/wrapper

umount /proc
umount /sys
poweroff -d 0 -f
